<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <title>Train_Connection_Prediction:TCP</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <!-- Material Design Bootstrap -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.10/css/mdb.min.css" rel="stylesheet">
  <!-- Your custom styles (optional) -->
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.min.css') }}">
  <!-- Timepicker -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/css/tempusdominus-bootstrap-4.min.css" />
  <style type="text/css">
    html,
    body,
    header,
    .view {
      height: 100%;
    }

    @media (max-width: 740px) {
      html,
      body,
      header,
      .view {
        height: 1000px;
      }
    }

    @media (min-width: 800px) and (max-width: 850px) {
      html,
      body,
      header,
      .view {
        height: 650px;
      }
    }
    /* Progressbar space */
    #pgr_bar {
      margin: 5px;
      height: 8px;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    @media (min-width: 800px) and (max-width: 850px) {
      .navbar:not(.top-nav-collapse) {
        background: #1C2331 !important;
      }
    }

    .card-header .fa {
      transition: .3s transform ease-in-out;
    }
    .card-header .collapsed .fa {
      transform: rotate(-90deg);
    }

    .autocomplete-suggestions { border: 1px solid #FFFFFF00; background: #212529; overflow: auto; color: #FFF;}
    .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
    .autocomplete-selected { background: #000; }
    .autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
    .autocomplete-group { padding: 2px 5px; }
    .autocomplete-group strong { display: block; border-bottom: 1px solid #FFF; }

    /* Experiences */
    ul.experiences {
        padding-left: 30px;
        margin-top: -10px;
    }
    ul.experiences li {
        padding-left: 10px;
        list-style: none;
        background: url('../img/misc/list-bullet-darkgray.png') no-repeat;
        position:relative; /* so that pseudoelements are positioned relatively to their "li"s*/
        /* use padding-bottom instead of margin-bottom.*/ 
        margin-bottom: 0; /* This overrides previously specified margin-bottom */
        padding-bottom: 0em;
    }
    ul.experiences li.start {
        padding-top: 6px;
    }

    ul.experiences li.train {
      padding-left: 30px;
      margin-bottom: 0em;
      list-style: none;
    }
    .where {
        font-size: 1.1em;
        font-weight: 300;
        display: inline;
        margin-right: 0.5em;
        background-color: #444444;
        display: inline-block;
        padding: 0 12px;
        margin: -5px 0.5em 0 0 !important;
        -webkit-border-radius: 3px;
        -moz-border-radius: 3px;
        border-radius: 3px;
        border-color: #444;
        border-style: solid;
        border-width: 1px;
    }
    .where.green {
    background-color: #1bb315;
    }
    .where.orange {
    background-color: #fcb603;
    }
    .where.red {
    background-color: #d12626;
    }
    .info {
        font-size: 0.9em;
        display: block;
        margin-left: 0.5em;
    }
    .description {
        display: block;
        margin-top: 5px;
        margin-bottom: 5px;
    }
    /* BORDERS AND BULLETS */

    p {
        /*CSS reset*/
        margin-bottom: 0;
    }

    ul.experiences li:after {
        /* bullets */
        content: url('http://upload.wikimedia.org/wikipedia/commons/thumb/3/30/RedDisc.svg/20px-RedDisc.svg.png');
        position: absolute;
        left: -26px; /*adjust manually*/
        top: 0px;
    }

    ul.experiences li:before {
        /* lines */
        content:"";
        position: absolute;
    }
    ul.experiences li.start:before {
        /* lines */
        content:"";
        position: absolute;
        left: -16px; /* adjust manually */
        border-left: 1px solid black;
        height: 160%;
        width: 1px;
        top: 12px;
    }
    ul.experiences li.train:after {
        /* bullets */
        content: "";
        position: absolute;
        left: -26px; /*adjust manually*/
        top: 0px;
    }

    ul.experiences li:last-child:before {
        /* last li's line */
      height: 6px; /* shorten the line so it goes only up to the bullet. Is equal to first-child:before's top */
    }

  </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar">
    <div class="container">

      <!-- Brand -->
      <a class="navbar-brand" href="#">
        <strong>Train_Connection_Prediction: TCP</strong>
      </a>

      <!-- Collapse -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Links -->
      <div class="collapse navbar-collapse" id="navbarSupportedContent">

        <!-- Left -->
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">Home
              <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#about">About TCP</a>
          </li>
        </ul>

        <!-- Right -->
        <ul class="navbar-nav nav-flex-icons">
          <li class="nav-item">
            <a href="https://youtu.be/4jIRFQcO70M" class="nav-link border border-light rounded" target="_blank">
              <i class="fab fa-youtube mr-2"></i> Youtube Video
            </a>
          </li>
        </ul>

      </div>

    </div>
  </nav>
  <!-- Navbar -->

  <!-- Full Page Intro -->
  <div class="view full-page-intro"
    style="background-image: url('static/ice.jpg'); background-repeat: no-repeat; background-size: cover;">

    <!-- Mask & flexbox options-->
    <div class="mask rgba-black-light d-flex justify-content-center align-items-center">

      <!-- Content -->
      <div class="container">

        <!--Grid row-->
        <div class="row wow fadeIn">

          <!--Grid column-->
          <div class="col-md-6 mb-4 white-text text-center text-md-left">

            <h2 class="display-5 font-weight-bold">Train_Connection_Prediction: TCP</h2>

            <hr class="hr-light">

            <p>
              <strong>Ihre Verbindungsvorhersage</strong>
            </p>

            <p class="mb-4 d-none d-md-block">
            </p>

          </div>
          <!--Grid column-->

          <!--Grid column-->
          <div class="col-md-6 col-xl-5 mb-4">

            <!--Card-->
            <div class="card">

              <!--Card content-->
              <div class="card-body bg-dark">

                <!-- Form -->
                <input id="csrf_token" name="csrf_token" type="hidden" value="ImUyOTMyNDRlYmU3ZjRiNjRjZWNmYmFiOTJjODEyMTcxZGQ3NGM1NDIi.XbBLWw.rDReWPt-E3KtzwHTfn2JiWwiuuM">
                <form id="input" name="" method="post">
                  <!-- Heading -->
                  <h3 class="white-text text-center">
                    <strong>Verbindung finden:</strong>
                  </h3>
                  <hr>
                  <!-- Start Bhf Form-->
                  <div class="md-form">
                    <i class="fas fa-train prefix grey-text"></i>
                    <label class="form-control-label" for="startbhf">Start Bahnhof</label>
                    <input class="form-control white-text typeahead" id="startbhf" name="startbhf" type="text" value="">
                  </div>
                  <!-- End Bhf Form -->
                  <div class="md-form">
                    <i class="fas fa-train prefix grey-text"></i>
                    <label class="form-control-label" for="zielbhf">Ziel Bahnhof</label>
                    <input class="form-control white-text typeahead" id="zielbhf" name="zielbhf" type="text" value="">
                  </div>
                  <!-- Date Form -->
                  <div class="md-form">
                      <i class="fas fa-calendar prefix grey-text"></i>
                      <label class="form-control-label" for="time">Datum</label>
                      <input autocomplete="off" class="form-control white-text" data-target="#datetimepicker" data-toggle="datetimepicker" id="datetimepicker" name="time" type="text" value="">
                  </div>

                  <div class="text-center">
                    <input class="btn btn-indigo" id="" name="submit" type="submit" value="Send">
                  </div>

                </form>
                <!-- Form -->

              </div>

            </div>
            <!--/.Card-->

          </div>
          <!--Grid column-->

        </div>
        <!--Grid row-->

      </div>
      <!-- Content -->

    </div>
    <!-- Mask & flexbox options-->

  </div>
  <!-- Full Page Intro -->

  <!--Main layout-->
  <main>
    <div class="container">
      <!--Section: Ergebnisse-->
      <section class="mt-5 wow fadeIn">
        <!--Grid row-->
        <div id="erg" role="tablist" aria-multiselectable="true">
          <!-- Output Area -->
        </div>
        <!-- ProgressBar -->
        <div class="row" id="pgr_bar"></div>
        <!--Grid row-->
      </section>
      <!--Section: Ergebnisse-->

      <!--Section: About-->
      <section id="about">

        <h3 class="h3 text-center mb-5">About TCP</h3>

        <!--Grid row-->
        <div class="row wow fadeIn">
            <!--Second row-->
            <div class="row">
              <div class="col-0 mr-3">
                <i class="fas fa-book fa-2x blue-text"></i>
              </div>
              <div class="col-10">
                <!-- <h5 class="feature-title">Title?</h5> -->
                <p class="grey-text">Die Bahn bietet auf ihrer Webseite eine statische Reiseplanung an, die auf den Zeiten im Fahrplan basiert. Gerade die Fernzüge der Bahn sind aber oft verspätet, so dass man einen Anschlusszug nicht erreicht. Für Bahnfahrer ist es wichtig zu wissen, ob eine gewählte Verbindung wahrscheinlich funktionieren wird und man wie geplant am Ziel ankommt.  Unsere Künstliche Intelligenz sagt auf Basis der historischen Zugverlaufsdaten und potentiell relevanter Information wie Feriendaten oder Wetter vorher, ob man mit einer möglichen Zugverbindung auch wirklich ankommt. Eine solche Vorhersage ist nicht nur interessant für die Fahrgäste, sondern auch für die Bahn selber, da sie die Information nutzen könnte, um die Fahrpläne zu verbessern. Als Vision ließe sich mit unserem Zugverbindungsvorhersagesystem also der öffentliche Verkehr verlässlicher machen und somit den Umstieg für mehr Menschen attraktiver.<br>
                Um eine verlässliche Vorhersage zu ermöglichen, haben wir eine Vielzahl unterschiedlicher Daten zusammengetragen, was viel komplexer war als ursprünglich vermutet. Zum Beispiel gibt es kaum historische Wetterdaten, für die man nicht zahlen muss,  und viele undokumentierte und nicht funktionierende APIs der Bahn (hier ein Video dazu).<br>
                Zu den von uns gesammelten Daten zählen:<br>
                •    Historische Zugdaten und Daten aus Fahrplänen<br>
                •    Ferien und Feiertage<br>
                •    Wetterdaten<br>
                •    Breiten/Längengrade und Abstände zwischen den Bahnhöfen<br>
                Auf Basis dieser Daten haben wir verschiedene Regressionsmodelle und Classifier trainiert. Besonders der Random Forrest Classifier konnte gut verschiedene Verspätungsintervalle vorhersagen. Über eine Weboberfläche sucht der Nutzer gewünschte Verbindungen heraus und der Classifier sagt die Verspätungsintervalle vorher.<br> Diese werden  analysiert, zu einer Verbindungswahrscheinlichkeit kombiniert und die Verbindungen dann entsprechend farblich dargestellt.<br>
                Das Projekt ist aber noch lange nicht fertig: Uns fehlen  Informationen zu Nahverkehrszügen und wir berücksichtigen noch keine zugrundeliegende Gründe von Verspätung (wie z.B. Signalstörung). Der Prototyp ist aber voll funktionsfähig und bietet so eine gute Grundlage für weitere Arbeit an diesem spannenden Problem.<br>

                </p>
              </div>
        </div>
        <!--/Grid row-->

      </section>
      <!--Section: About-->
    </div>
  </main>

  <!--Footer-->
  <footer class="page-footer text-center font-small mt-4 wow fadeIn">

    <!--/.Call to action-->

    <hr class="my-4">

    <!-- Social icons -->
    <div class="pb-4">
      <a href="https://youtu.be/4jIRFQcO70M" target="_blank">
        <i class="fab fa-youtube mr-3"></i>
      </a>

      <a href="https://github.com/mariusdkm" target="_blank">
        <i class="fab fa-github mr-3"></i>
      </a>
    </div>
    <!-- Social icons -->

    <!--Copyright-->
    <div class="footer-copyright py-3">
      © 2019 Copyright:
      <a href="https://github.com/mariusdkm" target="_blank"> _® </a>
    </div>
    <!--/.Copyright-->

  </footer>
  <!--/.Footer-->

  <!-- SCRIPTS -->

  <!-- Initializations -->
  <!-- JQuery + Standarts-->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.10/js/mdb.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>

  <!-- Timepicker -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
  <script type="text/javascript"src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/js/tempusdominus-bootstrap-4.min.js"></script>

  <!-- ProgressBar -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/progressbar.js/1.0.1/progressbar.min.js" integrity="sha256-VupM2GVVXK2c3Smq5LxXjUHBZveWTs35hu1al6ss6kk=" crossorigin="anonymous"></script>

  <!-- SocketIO -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.10/jquery.autocomplete.min.js"></script>
  <!-- Custom Script -->
  <script type="text/javascript">

    //Datetimepicker
    $('#datetimepicker').datetimepicker({
      icons: {
        time: 'fas fa-clock',
        date: 'fas fa-calendar',
      }, format: 'DD.MM.YYYY HH:mm'
    });
  
    //Sets labels over forms on top or on bottom
    $('input[type=text]').each(function (i, element) {
      if (element.value.length > 0) {
        $(this).siblings('label').addClass('active');
      }
      else {
        $(this).siblings('label').removeClass('active');
      }
    });

    //Progressbar init
    var bar = new ProgressBar.Line(pgr_bar, {
      strokeWidth: 4,
      easing: 'easeInOut',
      duration: 100,
      color: '#ED6A5A',
      trailColor: '#eee',
      trailWidth: 1,
      svgStyle: {width: '100%', height: '100%'},
      to: {color: '#FFEA82'},
      from: {color: '#ED6A5A'},
      step: (state, bar) => {
        bar.path.setAttribute('stroke', state.color);
      }
    });

    

    //init socketio
    var socket = io('https://dkm.homeip.net:4000');
    var theadid = 0;
    var bhfs = [];
    socket.on('connect', function() {
        socket.emit('connected', {data: 'I\'m connected!'});
    });

    //Update progressbar
    socket.on('progress', function(msg) {
      bar.animate((msg.data)*0.01);
    });

    socket.on('bhfs', function(msg) {
      bhfs = msg.bhf;
      $('#startbhf').autocomplete({
        lookup: bhfs,
      });
      $('#zielbhf').autocomplete({
        lookup: bhfs,
      });
    });


    function display_connections(no, data, details){
      // console.log('data kkk')
      // console.log(data)
      // console.log('details kkk')
      // console.log(details)
      $('#erg').append(
        '<div id="card'+ no +'" class="card text-white bg-success">\
            <h5 class="card-header" role="tab" id="heading' + no + '">\
              <a class="collapsed d-block text-white" data-toggle="collapse" data-parent="#erg" href="#collapse'+ no +'" aria-expanded="false" aria-controls="collapse'+ no +'">\
                <table class="table table-sm" id="table' + no + '">\
                  <thead>\
                    <tr>\
                      <th scope="col" style="width: 25%;">Bahnhof</th>\
                      <th scope="col" style="width: 10%;">Zeit</th>\
                      <th scope="col" style="width: 15%;">Dauer</th>\
                      <th scope="col" style="width: 20%;">Umsteigen</th>\
                      <th scope="col">Produkte</th>\
                      <th scope="col">Anschlusswahrscheinlichkeit</th>\
                    </tr>\
                  </thead>\
                  <tbody>\
                    <tr>\
                      <td id="bhf" scope="col">'+ $("#startbhf").val() + '<br>' + $("#zielbhf").val() + '</td>\
                      <td id="time" scope="col">'+ data.departure + '<br>' + data.arrival+'</td>\
                      <td id="totaltime" scope="col"><b>' + data.time + '</b></td>\
                      <td id="trans" scope="col"><b>' + data.transfers + '</b></td>\
                      <td id="prod" scope="col"></td>\
                      <td id="prob" scope="col"><b>' +details[0].total_score+ '% '+ '</b> </td>\
                    </tr>\
                    </tbody>\
                </table>\
              </a>\
            </h5>\
            <div id="collapse'+ no +'" class="collapse" role="tabpanel" aria-labelledby="heading' + no + '">\
                <div class="card-body" id="details'+ no +'">\
                </div>\
            </div>\
        </div>');

      $.each(data.products, function(_i,value){
        $("#table" + no + " tbody td#prod").append(value + " ");
      });
      str = '<ul class="experiences">\
            <li class="start">\
              <div class="where">' + details[0].startbhf + '</div>\
              <p class="info">Gl.' + details[0].startplatform + ' ' + details[0].starttime + '</p>\
            </li>\
            <li class="train">\
              <p class="description">'+ details[0].starttrain + '</p>\
            </li>';
      
      $.each(details, function(i,value){
        console.log(typeof value !== 'undefined')
        if(value !== '' && i != 0){
          console.log(value)
          if (value.adelay5 < 0.10)
            ancolor = 'green'
          else if (value.adelay5 < 0.25)
            ancolor = 'orange'
          else
            ancolor = 'red'
          if (value.ddelay5 < 0.10)
            abcolor = 'green'
          else if (value.ddelay5 < 0.25)
            abcolor = 'orange'
          else
            abcolor = 'red'
          
          str = str.concat(
            '<li class="end">\
                <div class="where ' + ancolor + '">'+ value.anbhf + '</div>\
                <p class="info">Gl.'+ value.anplatform + ' ' + value.anzeit + '</p>\
            </li>\
            <li class="start">\
                <div class="where ' + abcolor + '">'+ value.abbhf + '</div>\
                <p class="info">Gl.'+ value.abplatform + ' ' + value.abzeit + '</p>\
            </li>\
            <li class="train">\
                <p class="description">'+ value.abtrain + '</p>\
            </li>'
          );
          
          
        }
      });
      str = str.concat(
          '<li class="end">\
            <div class="where">' + details[0].endbhf + '</div>\
            <p class="info">Gl.' + details[0].endplatform + ' ' + details[0].endtime + '</p>\
          </li>\
        </ul>');
      $('#details' + no).html(str);
      if(data.score == 0){
        console.log('Score 0')
        $("#card"+ no ).attr('class', 'card text-white bg-success');} //$('#card0').attr('style', 'background-color: #1bff00 !important');
      if(data.score == 1){
        console.log('Score 1')
        $("#card"+ no ).attr('class', 'card text-white bg-warning');}
      if(data.score == 2){
        console.log('Score 2')
        $("#card"+ no ).attr('class', 'card text-white bg-danger');}

    }
    
    
    //Display Output
    socket.on('output', function(msg) {
      msg.data = JSON.parse(msg.data);
      console.log("msg.data:")
      console.log(msg.data);
      console.log("msg.details:")
      console.log(msg.details);
      //Clear old Data
      $('#erg').html('');
      for (var i = 0; i < msg.data.length; i++) {
        display_connections(i, msg.data[i], msg.details[i]);
      }
      var position = $("#erg").offset().top - $("#erg").height() /2; 
        $("HTML, BODY").animate({ scrollTop: position }, 1000); //Scroll down
      
    });

    //thread id return ?remove?
    socket.on('thread', function(msg) {
      console.log(msg);
      theadid = msg.id;
    });
    socket.on('error', function(msg) {
      console.log(msg);
      $('#erg').html('\
      <div class="alert alert-danger alert-dismissible fade show" role="alert">\
        <strong>Holy guacamole!</strong> Looks like something went wrong.<br>\
        <small>For details see console<small>\
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">\
          <span aria-hidden="true">&times;</span>\
        </button>\
      </div>\
      ');
    });
    
    socket.on('debug', function(msg) {
      console.log(msg);
    });

    //called when form is submitted
    $('#input').submit(function () {
      $('#datetimepicker').datetimepicker('hide')
      if (bhfs.includes($("#startbhf").val()) && bhfs.includes($("#zielbhf").val())){
        var position = $("#pgr_bar").offset().top - $("#pgr_bar").height() /2; 
        $("HTML, BODY").animate({ scrollTop: position }, 1000); //Scroll down
        socket.emit('start', {"startbhf": $("#startbhf").val(), "zielbhf": $("#zielbhf").val(), "date": $("#datetimepicker").val()});
        //return false so the page isn't reloaded
        return false;
      }
      if (!bhfs.includes($("#startbhf").val()))
        $("#startbhf").fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100);
      if (!bhfs.includes($("#zielbhf").val()))
        $("#zielbhf").fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100);
      return false;
    });
    // Animations initialization
    new WOW().init();
  </script>
</body>
</html>
